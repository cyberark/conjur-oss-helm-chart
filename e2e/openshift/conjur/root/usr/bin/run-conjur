#!/bin/bash -e

PG_PORT=5432
SLEEP_TIME=1

if [ "$DATABASE_URL" == "" ]; then
  echo "ERROR: DATABASE_URL not specified!"
  exit 1
fi

if [ "$CONJUR_SEED_FILE" != "" ]; then
  echo "Seed file setting detected. Extracting relevant info..."
  if [ ! -f "$CONJUR_SEED_FILE" ]; then
    echo "ERROR! Cannot find seed file '$CONJUR_SEED_FILE'!"
    exit 1
  fi

  SOLO_PATH="/tmp/solo.json"
  echo "Extracting solo.json and grabbing its values..."
  seedfile-extractor "/etc/chef/solo.json" "$SOLO_PATH"

  echo "Extracting seedfile certificates..."
  hostname=$(jq -r '.conjur.hostname' "$SOLO_PATH")
  seedfile-extractor "/opt/conjur/etc/ssl/ca.pem" "/opt/conjur/etc/ssl/ca/tls.crt"
  seedfile-extractor "/opt/conjur/etc/ssl/$hostname.pem" "/opt/conjur/etc/ssl/cert/tls.crt"
  seedfile-extractor "/opt/conjur/etc/ssl/$hostname.key" "/opt/conjur/etc/ssl/cert/tls.key"


  # fix permissions on the private key
  chmod 600 "/opt/conjur/etc/ssl/cert/tls.key"

  echo "Extracting CONJUR_DATA_KEY..."
  seedfile-extractor "/opt/conjur/etc/possum.key" "/tmp/conjur_data_key"
  export CONJUR_DATA_KEY=$(cat /tmp/conjur_data_key)
  rm -rf /tmp/conjur_data_key

  echo "Composing connection string..."

  if [ "$CONJUR_DATABASE_HOSTNAME" == "" ]; then
    echo "ERROR! CONJUR_DATABASE_HOSTNAME env var not defined!"
    exit 1
  fi

  export DATABASE_URL="postgres://conjur@$CONJUR_DATABASE_HOSTNAME:$PG_PORT/conjur?sslcert=/opt/conjur/etc/ssl/cert/tls.crt&sslkey=/opt/conjur/etc/ssl/cert/tls.key&sslmode=require"
  echo "Using DATABASE_URL: '$DATABASE_URL'"

  echo "Seedfile data extracted!"
fi

# TODO: Wait for PG to be up before continuing

if [ "$DEBUG_CONTAINER" != "" ] && [ "$DEBUG_CONTAINER" != "false" ]; then
  echo "Container debugging activated... Waiting..."
  sleep 999d
fi

exec conjurctl $@
